name: Workflow
on: [push, pull_request]
permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
      - name: Install dependencies
        run: make packages
      - name: Run linters
        run: make lint
  
  backup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Create bundle
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          mkdir -p bundles
          git bundle create "bundles/${TIMESTAMP} ${{ github.event.repository.name }}.bundle" --all
          sha256sum "bundles/${TIMESTAMP} ${{ github.event.repository.name }}.bundle" > "bundles/${TIMESTAMP} ${{ github.event.repository.name }}.sha256"
      - name: Upload bundle via SFTP (ssh + scp)
        env:
          FTP_HOSTNAME: ${{ secrets.FTP_HOSTNAME }}   # storage.bunnycdn.com
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}   # Storage Zone name
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail
          sudo apt-get update && sudo apt-get install -y openssh-client sshpass

          # Ensure target directory exists
          sshpass -p "$FTP_PASSWORD" \
            ssh -o StrictHostKeyChecking=accept-new -p 22 "${FTP_USERNAME}@${FTP_HOSTNAME}" \
            "mkdir -p backups"

          # Upload files (handles spaces in names)
          for f in bundles/*; do
            base=$(basename "$f")
            sshpass -p "$FTP_PASSWORD" \
              scp -P 22 -o StrictHostKeyChecking=accept-new "$f" "${FTP_USERNAME}@${FTP_HOSTNAME}:backups/$base"
          done

          # Verify upload
          echo "Listing backups via SSH:"
          sshpass -p "$FTP_PASSWORD" \
            ssh -o StrictHostKeyChecking=accept-new -p 22 "${FTP_USERNAME}@${FTP_HOSTNAME}" \
            "ls -l backups"

  # test:
  #   runs-on: ubuntu-latest
  #   needs: lint
  #   env:
  #     CONFIG_MODULE: "test.config"
  #   strategy:
  #     matrix:
  #       python-version: ["3.12"]
  #   services:
  #     postgres:
  #       image: postgres:15
  #       env:
  #         POSTGRES_PASSWORD: postgres
  #         POSTGRES_USER: postgres
  #         POSTGRES_DB: web_test
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #       ports:
  #         - 5432:5432
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ matrix.python-version }}
  #         cache: "pip"
  #     - name: Install dependencies
  #       run: pip install -r requirements.txt -r requirements-dev.txt
  #     - name: Run database migrations
  #       run: alembic upgrade head
  #     - name: Run unit tests
  #       run: |
  #         pytest . \
  #           --cov=pytest_cov \
  #           --cov-report=xml:.cache/pytest/coverage.xml \
  #           --junitxml=.cache/pytest/results.xml \
  #           --verbose --tb=short --durations=10
  #     - name: Upload test results
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: test-results-${{ matrix.python-version }}
  #         path: .cache/pytest/results.xml
  #         retention-days: 30
  #     - name: Upload coverage report
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: coverage-${{ matrix.python-version }}
  #         path: .cache/pytest/coverage.xml
  #         retention-days: 30
