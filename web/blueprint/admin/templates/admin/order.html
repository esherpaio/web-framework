{% extends "admin.html" %}

{% block admin %}
    {% from "includes/order_details.html" import gen_order_details %}
    {% from "includes/order_shipping.html" import gen_order_shipping %}
    {% from "includes/order_billing.html" import gen_order_billing %}
    {% from "includes/order_lines.html" import gen_order_lines %}
    {% from "includes/order_refunds.html" import gen_order_refunds %}
    {% from "includes/order_shipments.html" import gen_order_shipments %}
    <div class="row g-3">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <h2 class="mb-0">
                    Order #{{ order.id }}
                </h2>
                <div class="d-grid d-sm-block gap-2">
                    {% if order.invoice %}
                        <a class="btn btn-info"
                           href="{{ url_for('admin.download_invoice', order_id=order.id, invoice_id=order.invoice.id) }}">
                            Download invoice
                        </a>
                    {% endif %}
                    {% if order.invoice %}
                        <a class="btn btn-info"
                           href="{{ url_for('admin.download_csv', order_id=order.id) }}">
                            Download CSV
                        </a>
                    {% endif %}
                    {% if not order.is_pending %}
                        <button class="btn btn-warning"
                                data-bs-toggle="modal"
                                data-bs-target="#modal-create-shipment">
                            Create shipment
                        </button>
                    {% endif %}
                    {% if order.is_pending %}
                        <button class="btn btn-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#modal-cancel-order">
                            Cancel order
                        </button>
                    {% endif %}
                    {% if order.is_refundable %}
                        <button class="btn btn-danger"
                                data-bs-toggle="modal"
                                data-bs-target="#modal-refund-order">
                            Create refund
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            {{ gen_order_details(order, refunds, false) }}
        </div>
        <div class="col-12 col-lg-4">
            {{ gen_order_shipping(order) }}
        </div>
        <div class="col-12 col-lg-4">
            {{ gen_order_billing(order) }}
        </div>
        <div class="col-12">
            {{ gen_order_lines(order, order_lines, false) }}
        </div>
        {% if order.shipments %}
            <div class="col-12">
                {{ gen_order_shipments(order, order.shipments) }}
            </div>
        {% endif %}
        {% if refunds %}
            <div class="col-12">
                {{ gen_order_refunds(order, refunds, false) }}
            </div>
        {% endif %}
    </div>
    <!-- modal cancel order -->
    <div id="modal-cancel-order"
         class="modal fade"
         tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-semibold">
                        Cancel order
                    </h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal">
                    </button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">
                        <b>This action is irreversible.</b>
                        The order will be cancelled.
                        A refund will be created if necessary.
                    </p>
                </div>
                <div class="modal-footer">
                    <button id="cancel-order"
                            class="btn btn-load btn-info"
                            onclick="cancelOrder({{ order.id }})">
                        Proceed
                    </button>
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- modal refund order -->
    <div id="modal-refund-order"
         class="modal fade"
         tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-semibold">
                        Create refund
                    </h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal">
                    </button>
                </div>
                <div class="modal-body">
                    <p>
                        <b>This action is irreversible.</b>
                        A refund will be created.
                        Please enter the amount you wish to refund below.
                        The default value is the maximum refundable amount.
                    </p>
                    <div class="input-group">
                        <span class="input-group-text">{{ order.currency.code }}</span>
                        <input required
                               id="refund-total-price"
                               class="form-control"
                               placeholder="Amount"
                               type="number"
                               step="0.01"
                               value="{{ order.remaining_refund_amount|price }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="create-refund"
                            class="btn btn-load btn-info"
                            onclick="refundOrder({{ order.id }})">
                        Proceed
                    </button>
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- modal create shipment -->
    <div id="modal-create-shipment"
         class="modal fade"
         tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-semibold">
                        Create shipment
                    </h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal">
                    </button>
                </div>
                <div class="modal-body">
                    <p>
                        <b>This action is irreversible.</b>
                        A shipment will be created and emailed to the customer.
                    </p>
                    <div class="input-group">
                        <span class="input-group-text">URL</span>
                        <input required
                               id="shipment-url"
                               class="form-control"
                               placeholder="URL"
                               type="text"
                               value="">
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="create-shipment"
                            class="btn btn-load btn-info"
                            onclick="createShipment({{ order.id }})">
                        Proceed
                    </button>
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
