{% extends "admin_main.html" %}
{% block admin_body %}
    <script>
    async function updateCart(cartId) {
        event.preventDefault();
        updateButton(`update-cart-coupon-code`, 1);
        const data = { coupon_code: document.getElementById('cart-coupon-code').value };
        await patchCartsId(cartId, emptyStrToNull(data));
        window.location.reload();
    }

    async function addCartItem(cartId) {
        event.preventDefault();
        updateButton(`add-cart-item`, 1);
        const data = {
            sku_id: parseInt(document.getElementById(`cart-item-sku-id`).value),
            quantity: parseInt(document.getElementById(`cart-item-quantity`).value),
        };
        await postCartsIdItems(cartId, data);
        window.location.reload();
    }
    async function updateCartItem(cartId, cartItemId) {
        event.preventDefault();
        updateButton(`update-cart-item-${cartItemId}`, 1);
        const data = {
            quantity: parseInt(document.getElementById(`cart-item-quantity-${cartItemId}`).value),
        };
        await patchCartIdItemsId(cartId, cartItemId, data);
        window.location.reload();
    }
    async function deleteCartItem(cartId, cartItemId) {
        event.preventDefault();
        updateButton(`delete-cart-item-${cartItemId}`, 1);
        await deleteCartIdItemsId(cartId, cartItemId);
        window.location.reload();
    }

    async function loadShipping(shipping) {

    }
    async function updateShipping(cart, silent = false) {
        let data = emptyStrToNull({
            address: document.getElementById('shipping-address').value,
            city: document.getElementById('shipping-city').value,
            country_id: parseInt(document.getElementById('shipping-country-id').value),
            email: document.getElementById('shipping-email').value,
            first_name: document.getElementById('shipping-first-name').value,
            last_name: document.getElementById('shipping-last-name').value,
            phone: document.getElementById('shipping-phone').value,
            state: document.getElementById('shipping-state').value,
            zip_code: document.getElementById('shipping-zip-code').value,
        });
        let shipping_id = null;
        if (cart.shipping_id) {
            resp = await patchShippingsId(cart.shipping_id, data, silent);
            if (resp) shipping_id = resp.data.id;
        }
        if (!shipping_id) {
            resp = await postShippings(data, silent);
            if (resp) shipping_id = resp.data.id;
        }
        data = { shipping_id: shipping_id };
        await patchCartsId(cart.id, data, silent);
        return cart.shipping_id == shipping_id;
    }
    async function loadBilling(billing) {

    }
    async function updateBilling(cart, silent = false) {
        let data = emptyStrToNull({
            address: document.getElementById('billing-address').value,
            city: document.getElementById('billing-city').value,
            company: document.getElementById('billing-company').value,
            country_id: parseInt(document.getElementById('billing-country-id').value),
            email: document.getElementById('billing-email').value,
            first_name: document.getElementById('billing-first-name').value,
            last_name: document.getElementById('billing-last-name').value,
            phone: document.getElementById('billing-phone').value,
            state: document.getElementById('billing-state').value,
            vat: document.getElementById('billing-vat').value,
            zip_code: document.getElementById('billing-zip-code').value,
        });
        let billing_id = null;
        if (cart.billing_id) {
            resp = await patchBillingsId(cart.billing_id, data, silent);
            if (resp) billing_id = resp.data.id;
        }
        if (!billing_id) {
            resp = await postBillings(data, silent);
            if (resp) billing_id = resp.data.id;
        }
        data = { billing_id: billing_id };
        await patchCartsId(cart.id, data, silent);
        return cart.billing_id == billing_id;
    }
    async function copyShippingToBilling() {
        const checkbox = document.getElementById("checkbox-use-shipping-for-billing");
        if (!checkbox.checked) return;
        const names = ["address", "city", "country-id", "email", "first-name", "last-name", "phone", "state", "zip-code"];
        for (const name of names) {
            document.getElementById(`billing-${name}`).value = document.getElementById(`shipping-${name}`).value;
        }
    }

    async function loadShipmentMethods(cart, currency) {
        let table = document.getElementById("shipment-methods");
        const tableBody = table.tBodies[0];
        while (tableBody.firstChild) tableBody.removeChild(tableBody.firstChild);

        resp = await getShipmentMethods({ "cart_id": cart.id });
        for (const shipment_method of resp.data) {
            const tr = document.createElement('tr');
            tableBody.appendChild(tr);

            const nameTd = document.createElement('td');
            nameTd.textContent = shipment_method.name;
            tr.appendChild(nameTd);

            const priceTd = document.createElement('td');
            priceTd.textContent = `${shipment_method.unit_price} ${currency.code}`;
            tr.appendChild(priceTd);
            
            const actionTd = document.createElement('td');
            actionTd.classList.add('text-end');
            tr.appendChild(actionTd);
            const formCheckDiv = document.createElement('div');
            formCheckDiv.classList.add('form-check', 'd-flex', 'justify-content-end');
            actionTd.appendChild(formCheckDiv);
            const input = document.createElement('input');
            input.id = `shipment-method-${shipment_method.id}`;
            input.classList.add('form-check-input');
            input.type = 'radio';
            input.name = 'shipment-method-id';
            input.value = `${shipment_method.id}`;
            input.addEventListener("click", () => updateShipmentMethod(cart));
            if (shipment_method.id === cart.shipment_method_id) {
                input.checked = true;
            }
            formCheckDiv.appendChild(input);
        }
    }

    async function triggerLoadShipmentMethods() {
        let cart = (await getCarts()).data[0];
        let updated = false;
        try {
            updated = await updateShipping(cart, true);
            await updateBilling(cart, true);
        } catch { return; }
        if (updated) {
            cart = (await getCarts()).data[0];
        }
        currency = (await getCurrenciesId(cart.currency_id)).data;
        await loadShipmentMethods(cart, currency)
    }

    async function updateShipmentMethod(cart) {
        event.preventDefault();
        let element = document.querySelector('input[name="shipment-method-id"]:checked');
        let shipment_method_id;
        if (element) {
            shipment_method_id = parseInt(element.value);
        } else {
            shipment_method_id = null;
        }
        let data = { shipment_method_id: shipment_method_id };
        await patchCartsId(cart.id, data);
    }

    async function loadCartItems(cart, currency) {
        let table = document.getElementById("cart-items");
        const tableBody = table.tBodies[0];
        while (tableBody.firstChild) tableBody.removeChild(tableBody.firstChild);

        resp = await getCartsIdItems(cart.id);
        for (const cart_item of resp.data) {
            const tr = document.createElement('tr');
            tableBody.appendChild(tr);

            const idTd = document.createElement('td');
            idTd.textContent = cart_item.id;
            tr.appendChild(idTd);

            const skuNameTd = document.createElement('td');
            skuNameTd.textContent = cart_item.sku_name;
            tr.appendChild(skuNameTd);

            const quantityTd = document.createElement('td');
            tr.appendChild(quantityTd);
            const quantityTdInput = document.createElement('input');
            quantityTdInput.id = `cart-item-quantity-${cart_item.id}`;
            quantityTdInput.classList.add("form-control", "form-control-sm");
            quantityTdInput.type = "number";
            quantityTdInput.value = cart_item.quantity;
            quantityTd.append(quantityTdInput);

            const unitPriceTd = document.createElement('td');
            unitPriceTd.textContent = `${cart_item.unit_price} ${currency.code}`;
            tr.appendChild(unitPriceTd);

            const actionsTd = document.createElement('td');
            actionsTd.classList.add('text-end');
            tr.appendChild(actionsTd);
            const actionsTdDiv = document.createElement('div');
            actionsTdDiv.classList.add("btn-group");
            actionsTd.append(actionsTdDiv);
            const actionsTdDivButtonUpdate = document.createElement('a');
            actionsTdDivButtonUpdate.id = `update-cart-item-${cart_item.id}`;
            actionsTdDivButtonUpdate.classList.add("btn", "btn-load", "btn-sm", "btn-outline-primary");
            actionsTdDivButtonUpdate.addEventListener("click", () => updateCartItem(cart.id, cart_item.id));
            actionsTdDivButtonUpdate.textContent = "Update";
            actionsTdDiv.append(actionsTdDivButtonUpdate);
            const actionsTdDivButtonDelete = document.createElement('a');
            actionsTdDivButtonDelete.id = `delete-cart-item-${cart_item.id}`;
            actionsTdDivButtonDelete.classList.add("btn", "btn-load", "btn-sm", "btn-outline-danger");
            actionsTdDivButtonDelete.addEventListener("click", () => deleteCartItem(cart.id, cart_item.id));
            actionsTdDivButtonDelete.textContent = "Delete";
            actionsTdDiv.append(actionsTdDivButtonDelete);
        }
    }

    async function addOrder(cartId) {
        event.preventDefault();
        let resp = await getCartsId(cartId);
        let cart = resp.data;
        let data = { 'cart_id': cart.id, 'trigger_mail': false };
        resp = await postOrders(data);
        let order = resp.data;
        const mollieRedirect = location.protocol + '//' + location.host;
        const redirect = location.protocol + '//' + location.host + URL_ADMIN_ORDERS + "/" + `${order.id}`;
        resp = await postOrdersIdPayments(order.id, { "redirect": mollieRedirect });
        window.location.href = redirect;
    }

    async function initializePage() {
        let cart = (await getCarts()).data[0];
        let currency = (await getCurrenciesId(cart.currency_id)).data;
        let countries = (await getCountries()).data;
        let user = (await getUsersId(cart.user_id)).data;

        let shipping_id = null;
        if (cart.shipping_id) {
            shipping_id = cart.shipping_id;
        } else if (user.shipping_id) {
            shipping_id = user.shipping_id;
        }
        if (shipping_id !== null) {
            shipping = (await getShippingsId(shipping_id)).data;
            loadShipping(shipping);
        }

        let billing_id = null;
        if (cart.billing_id) {
            billing_id = cart.billing_id;
        } else if (user.billing_id) {
            billing_id = user.billing_id;
        }
        if (billing_id !== null) {
            billing = (await getBillingsId(billing_id)).data;
            loadBilling(billing);
        }
        
        loadCartItems(cart, currency);
        loadShipmentMethods(cart, currency);


        let copyBillingElements = document.getElementsByClassName("copy-billing");
        Array.from(copyBillingElements).forEach(element => {
            element.addEventListener("change", () => debounce(copyShippingToBilling, 100));
        });
        updateShipmentMethodElements = document.getElementsByClassName("update-shipment-methods");
        Array.from(updateShipmentMethodElements).forEach(element => {
            element.addEventListener("change", () => debounce(triggerLoadShipmentMethods, 100));
        });
        // load shipping
        // load billing
        // load countries
    }

    document.addEventListener("DOMContentLoaded", initializePage);
    </script>

    <div class="row g-3">
        <div class="col-12">
            <div class="d-flex justify-content-between gap-2">
                <h2 class="mb-0">Add order</h2>
                <button class="btn btn-warning"
                        data-bs-toggle="modal"
                        data-bs-target="#modal-add-order">
                    Create
                    order
                </button>
            </div>
        </div>
        <div class="col-12">
            <h3>SKUs</h3>
            <div class="table-responsive">
                <table id="cart-items"
                       class="table rounded-2 overflow-hidden align-middle mb-0">
                    <thead class="table-secondary">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="table-light">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-12">
            <h3>Shipping</h3>
            <div class="row g-2">
                <div class="col-12 col-sm-6">
                    <div class="form-floating">
                        <input required
                               id="shipping-email"
                               class="form-control copy-billing"
                               type="email"
                               value="{{ cart.shipping.email if cart.shipping.email }}"
                               placeholder="Email"
                               autocomplete="email">
                        <label for="shipping-email">Email</label>
                    </div>
                </div>
                <div class="col-12 col-sm-6">
                    <div class="form-floating">
                        <input id="shipping-phone"
                               class="form-control copy-billing"
                               type="tel"
                               value="{{ cart.shipping.phone if cart.shipping.phone }}"
                               placeholder="Phone"
                               autocomplete="tel">
                        <label for="shipping-phone">Phone</label>
                    </div>
                </div>
                <div class="col-12 col-sm-6">
                    <div class="form-floating">
                        <input required
                               id="shipping-first-name"
                               class="form-control copy-billing"
                               type="text"
                               value="{{ cart.shipping.first_name if cart.shipping.first_name }}"
                               placeholder="First name"
                               autocomplete="given-name">
                        <label for="shipping-first-name">First name</label>
                    </div>
                </div>
                <div class="col-12 col-sm-6">
                    <div class="form-floating">
                        <input required
                               id="shipping-last-name"
                               class="form-control copy-billing"
                               type="text"
                               value="{{ cart.shipping.last_name if cart.shipping.last_name }}"
                               placeholder="First name"
                               autocomplete="family-name">
                        <label for="shipping-last-name">Last name</label>
                    </div>
                </div>
                <div class="col-12 col-sm-6">
                    <div class="form-floating">
                        <input required
                               id="shipping-address"
                               class="form-control copy-billing"
                               type="text"
                               value="{{ cart.shipping.address if cart.shipping.address }}"
                               placeholder="Address"
                               autocomplete="street-address">
                        <label for="shipping-address">Address</label>
                    </div>
                </div>
                <div class="col-12 col-sm-6">
                    <div class="form-floating">
                        <input required
                               id="shipping-city"
                               class="form-control copy-billing"
                               type="text"
                               value="{{ cart.shipping.city if cart.shipping.city }}"
                               placeholder="City"
                               autocomplete="address-level2">
                        <label for="shipping-city">City</label>
                    </div>
                </div>
                <div class="col-12 col-sm-4">
                    <div class="form-floating">
                        <input required
                               id="shipping-zip-code"
                               class="form-control copy-billing"
                               type="text"
                               value="{{ cart.shipping.zip_code if cart.shipping.zip_code }}"
                               placeholder="Postal code"
                               autocomplete="postal-code">
                        <label for="shipping-zip-code">Postal code</label>
                    </div>
                </div>
                <div class="col-12 col-sm-4">
                    <div class="form-floating">
                        <input id="shipping-state"
                               class="form-control copy-billing"
                               type="text"
                               value="{{ cart.shipping.state if cart.shipping.state }}"
                               placeholder="State"
                               autocomplete="address-level1">
                        <label for="shipping-zip-code">State</label>
                    </div>
                </div>
                <div class="col-12 col-sm-4">
                    <div class="form-floating">
                        <select required
                                id="shipping-country-id"
                                class="form-select update-pricing update-shipment-methods copy-billing"
                                autocomplete="country-name">
                            <option selected disabled value="">Make a selection</option>
                            {% for x in cache.countries %}
                                <option {{ 'selected' if x.id==cart.shipping.country_id }} value="{{ x.id }}">
                                    {{ x.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <label for="shipping-country-id">Country</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <h3>Billing</h3>
            <div class="form-check mb-2">
                <input class="form-check-input"
                       type="checkbox"
                       value=""
                       id="checkbox-use-shipping-for-billing"
                       data-bs-toggle="collapse"
                       data-bs-target=".collapse-billing"
                       data-bs-animation="false"
                       aria-expanded="true"
                       onclick="copyShippingToBilling();">
                <label class="form-check-label" for="checkbox-use-shipping-for-billing">
                    Use shipping as billing information
                </label>
            </div>
            <div class="row g-2">
                <div class="col-12 col-sm-6 collapse-billing show">
                    <div class="form-floating">
                        <input required
                               id="billing-email"
                               class="form-control"
                               type="email"
                               value="{{ cart.billing.email if cart.billing.email }}"
                               placeholder="Email"
                               autocomplete="email">
                        <label for="billing-email">Email</label>
                    </div>
                </div>
                <div class="col-12 col-sm-6 collapse-billing show">
                    <div class="form-floating">
                        <input {{ 'required' if cart.shipment_method.phone_required }}
                               id="billing-phone"
                               class="form-control"
                               type="tel"
                               value="{{ cart.billing.phone if cart.billing.phone }}"
                               placeholder="Phone"
                               autocomplete="tel">
                        <label for="billing-phone">Phone</label>
                    </div>
                </div>
                <div class="col-12 col-sm-6 collapse-billing show">
                    <div class="form-floating">
                        <input required
                               id="billing-first-name"
                               class="form-control"
                               type="text"
                               value="{{ cart.billing.first_name if cart.billing.first_name }}"
                               placeholder="First name"
                               autocomplete="given-name">
                        <label for="billing-first-name">First name</label>
                    </div>
                </div>
                <div class="col-12 col-sm-6 collapse-billing show">
                    <div class="form-floating">
                        <input required
                               id="billing-last-name"
                               class="form-control"
                               type="text"
                               value="{{ cart.billing.last_name if cart.billing.last_name }}"
                               placeholder="First name"
                               autocomplete="family-name">
                        <label for="billing-last-name">Last name</label>
                    </div>
                </div>
                <div class="col-12 col-sm-6 collapse-billing show">
                    <div class="form-floating">
                        <input required
                               id="billing-address"
                               class="form-control"
                               type="text"
                               value="{{ cart.billing.address if cart.billing.address }}"
                               placeholder="Address"
                               autocomplete="street-address">
                        <label for="billing-address">Address</label>
                    </div>
                </div>
                <div class="col-12 col-sm-6 collapse-billing show">
                    <div class="form-floating">
                        <input required
                               id="billing-city"
                               class="form-control"
                               type="text"
                               value="{{ cart.billing.city if cart.billing.city }}"
                               placeholder="City"
                               autocomplete="address-level2">
                        <label for="billing-city">City</label>
                    </div>
                </div>
                <div class="col-12 col-sm-4 collapse-billing show">
                    <div class="form-floating">
                        <input required
                               id="billing-zip-code"
                               class="form-control"
                               type="text"
                               value="{{ cart.billing.zip_code if cart.billing.zip_code }}"
                               placeholder="Postal code"
                               autocomplete="postal-code">
                        <label for="billing-zip-code">Postal code</label>
                    </div>
                </div>
                <div class="col-12 col-sm-4 collapse-billing show">
                    <div class="form-floating">
                        <input id="billing-state"
                               class="form-control"
                               type="text"
                               value="{{ cart.billing.state if cart.billing.state }}"
                               placeholder="State"
                               autocomplete="address-level1">
                        <label for="billing-zip-code">State</label>
                    </div>
                </div>
                <div class="col-12 col-sm-4 collapse-billing show">
                    <div class="form-floating">
                        <select required
                                id="billing-country-id"
                                class="form-select update-pricing"
                                autocomplete="country-name">
                            <option selected disabled value="">Make a selection</option>
                            {% for x in cache.countries %}
                                <option {{ 'selected' if x.id==cart.billing.country_id }} value="{{ x.id }}">
                                    {{ x.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <label for="billing-country-id">Country</label>
                    </div>
                </div>
                <div class="col-12 col-sm-6">
                    <div class="form-floating">
                        <input id="billing-company"
                               class="form-control update-pricing"
                               type="text"
                               value="{{ cart.billing.company if cart.billing.company }}"
                               placeholder="Company"
                               autocomplete="organization">
                        <label for="billing-company">Company</label>
                    </div>
                </div>
                <div class="col-12 col-sm-6">
                    <div class="form-floating">
                        <input id="billing-vat"
                               class="form-control"
                               type="text"
                               value="{{ cart.billing.vat if cart.billing.vat }}"
                               placeholder="VAT">
                        <label for="billing-vat">VAT</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <h3>Shipment methods</h3>
            <div class="table-responsive">
                <table id="shipment-methods"
                       class="table rounded-2 overflow-hidden align-middle mb-0">
                    <thead class="table-secondary">
                        <tr>
                            <th>Name</th>
                            <th>Price</th>
                            <th class="text-end">Selection</th>
                        </tr>
                    </thead>
                    <tbody class="table-light">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-add-order" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>
                        <b>This action is irreversible.</b>
                        The customer will not be notified automatically.
                        A payment link will be created, which you can retrieve from the order page.
                    </p>
                </div>
                <div class="modal-footer">
                    <button id="add-order"
                            class="btn btn-load btn-warning"
                            onclick="addOrder({{ cart.id }})">Proceed</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
{% endblock admin_body %}
